# onmyoji-wiki 项目计划（Wiki + 编辑器双态）

## 项目概述

- 项目名称：onmyoji-wiki
- 目标：构建一个可 SEO 的静态 Wiki，同时在指定路径提供接近 Notion/Confluence 的编辑体验
- 核心技术方向：Nuxt Content(MDC) + Milkdown + yys-editor 插件化嵌入 + 双存储（localStorage / File System Access API）
- 当前日期基线：2026-02-26

## 目标架构

### 模式 A：静态内容站（面向访客）

- 使用 Nuxt Content + MDC 渲染页面
- 支持静态生成与 SEO
- 流程图仅使用 render-only 预览能力（默认禁用快捷键/编辑交互）

### 模式 B：管理端编辑器（面向作者）

- 路径建议：`/editor`
- 集成 Milkdown 作为主编辑器
- 通过 Milkdown 自定义块/指令打开 yys-editor 进行图编辑
- 保存时将图数据回写到 Markdown（内联或外部 JSON）
- 支持两种保存方式：浏览器 localStorage（默认）与本地目录文件回写（可选）

## 范围定义

### 本期范围（In Scope）

- 打通 Markdown -> MDC -> FlowPreview 渲染链路
- 设计并实现 yys-editor 插件分级策略（render-only/interactive）
- 在 editor 路径落地 Milkdown 编辑能力
- 设计并实现双存储策略（localStorage / File System Access API）
- 建立内容发布流程（草稿、审核、发布）

### 非本期范围（Out of Scope）

- 多人实时协作（CRDT）
- 复杂权限模型（细粒度 RBAC）
- 全量可视化页面搭建器

## 里程碑计划

| 里程碑 | 时间窗口 | 目标 | 状态 |
|------|------|------|------|
| M1 | 第 1 周 | 稳定内容渲染链路与 FlowPreview 数据规范 | 已完成 |
| M2 | 第 2 周 | yys-editor 插件分级与安全模式（静态页默认安全） | 已完成 |
| M3 | 第 3 周 | Milkdown 基础接入（/editor）与双存储能力 | 已完成 |
| M4 | 第 4 周 | Milkdown <-> yys-editor 块联动编辑 | 已完成 |
| M5 | 第 5 周 | 发布流程、SEO、构建优化 | 进行中 |
| M6 | 第 6 周 | 回归测试、文档完善、灰度上线 | 未开始 |

## 模块进度基线

| 模块 | 完成度 | 状态 | 备注 |
|------|--------|------|------|
| 内容站基础（Nuxt Content + MDC） | 70% | 进行中 | 访客渲染链路稳定，剩余 SEO 细化与发布流程联调 |
| FlowPreview 展示链路 | 85% | 进行中 | 已支持 render-only 预览与数据兼容，待补 E2E 回归 |
| yys-editor 插件化接口 | 100% | 已完成 | 已支持 render-only/interactive 分级与插件/节点注入 |
| Milkdown 编辑体验 | 98% | 进行中 | 已修复 `/editor` 工具栏命令首次不生效问题；编辑视图切换（可视/Markdown/双栏）与流程块插入/渲染/编辑验收通过；支持流程块剪切/粘贴（含会话缓存与末尾回退），并启用 cursor/trailing 改善末尾可编辑性 |
| 编辑器持久化（localStorage / File System Access） | 90% | 进行中 | 已支持 localStorage、目录读写、导入导出，待补异常场景自动化 |
| Editor 路径与鉴权 | 35% | 进行中 | `/editor` 已上线，鉴权与权限策略未接入 |
| 发布与回滚流程 | 20% | 进行中 | 仅完成基础流程规划，未落地发布编排 |
| 测试与质量门禁 | 30% | 进行中 | 已建立构建验证，缺少 E2E 与关键链路自动化测试 |

**总体完成度：69%**

## 关键任务拆解

### 阶段 1：稳定静态展示能力

1. 规范 flow 数据格式（`GraphData` 与导出数据兼容）
2. FlowPreview 增加 `src/data` 变更监听与错误态展示
3. 引入 `content.config.ts` 明确 collection/schema
4. 修订 README 与实际实现一致

### 阶段 2：插件安全分级

1. 在 yys-editor 暴露插件注入入口（插件与节点注册解耦）
2. 定义 `render-only` 与 `interactive` 两级能力
3. 静态站默认 `render-only`
4. editor 编辑态按需启用 `interactive`

### 阶段 3：Milkdown 编辑端

1. 新增 `/editor` 页面壳（已完成）
2. 集成 Milkdown 基础编辑器（已完成）
3. 抽象存储驱动（`localStorage` / `file-system`）（已完成）
4. 实现本地目录打开与文件读写回写（File System Access API）（已完成）
5. 实现 localStorage 兜底与导入/导出能力（不支持 FSA 浏览器可用）（已完成）
6. 实现 yys-editor 块插件（打开、编辑、写回）（已完成）
7. 统一序列化策略（Markdown 内联/外部 JSON）（进行中，当前默认内联并兼容 `fileList` 结构）

### 阶段 4：发布与质量

1. 草稿-审核-发布流程定义
2. SSG/SEO 验收与性能优化
3. E2E 回归用例（关键路径）
4. 上线与回滚预案

## 下一步任务（2026-02-26）

1. 补齐 `/editor` 关键链路 E2E：插入/编辑/删除流程块、刷新后数据一致性、localStorage 与 FSA 双路径回归。
2. 完成编辑端鉴权方案（最小可用）：限制 `/editor` 访问入口并补充错误提示页。
3. 完成发布流程文档与脚本：草稿-审核-发布-回滚操作手册与最小自动化脚本。
4. 将 `yys-editor` 本地联调流程整理为稳定发布流程（版本号策略 + 发布后 wiki 升级步骤）。

## 新增优化需求池（2026-02-26，待排期）

### 优化组 A：资产管理与跨端兼容

1. 在 `yys-editor` 提供用户资产管理能力：支持用户上传式神/御魂/自定义素材并分类管理。
2. 定义统一资产引用方案：优先使用相对路径 + `manifest`（含版本号、校验信息）避免跨环境绝对路径失效。
3. 明确双场景行为：
   - 场景 1（仅 yys-editor 单独使用并导出图片）：资源缺失时使用占位图 + 非阻塞告警，允许继续导出。
   - 场景 2（JSON 交给 onmyoji-wiki 渲染）：默认“可渲染优先”，资源缺失时页面不崩溃并输出缺失清单；保留可配置严格模式（按需报错）。
4. 设计 yys-editor 与 onmyoji-wiki 的资产同步边界：核心公共资产由 yys-editor 维护，wiki 通过同步流程按需镜像。

### 优化组 B：Dynamic Group + 规则静态检查

1. 使用 Context7 调研 LogicFlow 的 dynamic group 能力与约束边界，形成技术结论后再落地实现。
2. 在 dynamic group（队伍）范围内引入规则检查框架，支持黑白名单与组合冲突检测。
3. 首批规则示例（可配置）：
   - 式神-御魂组合黑名单（如：辉夜姬不应带破势）。
   - 队伍内冲突检查（如：千姬与腹骨清姬不应同队）。
   - 队伍关键职责检查（如：鬼火位缺失提示）。
4. 规则配置需要双端可复用（yys-editor / onmyoji-wiki）：统一 schema、版本与默认规则集，避免双维护漂移。

### 优化组 C：/editor 预览与视口体验

1. 修复 Markdown 所见即所得模式下流程块高度不可编辑问题，支持块级高度设置与即时预览。
2. 优化嵌入画布定位策略，避免“内容在无限画布远端导致不可见”：
   - 默认进入时 `fit-to-content`；
   - 支持对齐到左上主内容区域；
   - 保留缩放与重置视口入口。
3. 评估并实现“显示位置锚点”策略，保证 Markdown 预览与 editor 弹层的可预期一致性。
4. 修复流程块插入后的布局操作能力：支持在 `/editor` 中调整流程块位置（至少支持拖拽排序或上移/下移），避免“只能删除不能移动”。

### 优化组 D：稳定性与协作体验

1. 修复 `/editor` 下 Milkdown 工具栏测试项不生效问题。（已完成，2026-02-26）
2. 完成本地模式数据结构与缓存优化（当前尚未实现，需明确缓存层与失效策略）。
3. 导出能力升级：支持导出协作包（zip），包含 Markdown + JSON + 资源清单，便于创作者交付与 wiki 相对路径渲染。
4. 统一 yys-editor（Quill）与 onmyoji-wiki（Milkdown）的工具栏视觉与交互风格，降低用户切换认知成本。
5. 对 yys-editor 矢量节点缩放链路加入防抖/节流与渲染优化，缓解快速缩放卡顿。

## 风险与应对

| 风险 | 影响 | 应对策略 |
|------|------|------|
| 快捷键污染静态页面 | 高 | 静态页强制 render-only；快捷键仅 editor 且焦点内生效 |
| SSR/SSG 构建失败 | 高 | 插件初始化仅客户端执行；失败自动降级为纯渲染 |
| 数据格式漂移 | 中 | 统一 schema 版本与迁移器 |
| File System Access API 浏览器兼容性不足 | 中 | 默认 localStorage；仅在支持浏览器启用目录模式并提示能力差异 |
| 包体积过大 | 中 | 编辑端按路由分包，前台不加载交互插件 |
| 资源路径不一致 | 中 | 统一 assetBaseUrl 与同步脚本 |

## 验收标准

1. 访客路径可静态渲染并通过 SEO 基础检查
2. Markdown 中流程图在无交互插件下稳定展示
3. `/editor` 可编辑并保存图数据，回到访客页可正确渲染
4. `/editor` 支持 localStorage 模式保存/恢复
5. `/editor` 在支持浏览器下可打开本地目录并保存回原文件
6. 构建与预览命令可稳定执行
7. 关键流程具备最小回归测试

## 进度更新规则

- 仅在用户明确确认“某任务已完成”后，更新对应步骤与总体完成度
- 未确认完成前，不主动修改完成百分比
- 只更新被确认完成的模块，其他条目保持不变

## 更新记录

- 2026-02-26：新增优化需求池（资产管理、dynamic group 规则静态检查、/editor 预览定位、协作导出包与性能优化）
- 2026-02-26：完成流程块“剪切/粘贴”主路径并启用 cursor/trailing，缓解文档末尾流程块后的光标可编辑性问题
- 2026-02-26：验收第 3 项“流程块插入、渲染与编辑”确认完成，并同步模块进度
- 2026-02-26：验收第 12 项“编辑视图切换（可视/Markdown/双栏）”确认完成，并同步模块进度
- 2026-02-26：完成优化组 D-1：修复 `/editor` 工具栏命令首次进入不生效问题，并补充验收排查点
- 2026-02-26：更新里程碑状态（M3/M4 完成），补充下一步任务与模块进度基线
- 2026-02-26：/editor 支持 yys-flow 内联渲染、悬浮操作（编辑/删除）、flow-demo 结构兼容、弹层画布尺寸稳定化
- 2026-02-25：/editor 中 yys-flow 编辑弹层尺寸修复；支持 yys-flow 顶层 `height` 解析与序列化
- 2026-02-24：初始化计划文档（v1.0），建立双态架构与 6 周里程碑
- 2026-02-24：完成阶段 2（插件安全分级），前台默认 render-only，editor 按需 interactive
- 2026-02-24：新增编辑端双存储策略规划（localStorage 默认 + File System Access API 可选）
